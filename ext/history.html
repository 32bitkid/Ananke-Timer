<!DOCTYPE html>
<html>
<head>
<title>History</title>
<script type="text/javascript" src='ananke.min.js'></script>
<script type="text/javascript">
Date.prototype.getHumanTime = function() {
	var hours = this.getHours() + 1
	var pm = (hours >= 12)
	if(pm) hours -= 12

	var minutes = this.getMinutes();
	if(minutes < 10) minutes = "0" + minutes;
	return hours+":"+minutes + " " + ((pm)?"pm":"am");

}

window.Ananke.HistoryController = function(options) {
	this.options = options
	this.currentIndex = 0;
	this.update();

	this.options.nextButton.click(jQuery.proxy(this.handleNext, this));
	this.options.previousButton.click(jQuery.proxy(this.handlePrevious, this));
}

window.Ananke.HistoryController.prototype.handleNext = function() {
	this.next();
}

window.Ananke.HistoryController.prototype.handlePrevious = function() {
	this.previous();
}

window.Ananke.HistoryController.prototype.getDates = function() {
	return this.options.historyRepo.availableDates();
}

window.Ananke.HistoryController.prototype.getSelectedDate = function() {
	return this.options.historyRepo.availableDates()[this.currentIndex];
}

window.Ananke.HistoryController.prototype.next = function() {
	var max = this.getDates().length;
	this.currentIndex++;
	if(this.currentIndex >= max) this.currentIndex = 0;
}

window.Ananke.HistoryController.prototype.prev = function() {
	this.currentIndex--;
	if(this.currentIndex < 0) this.currentIndex = this.getDates().length - 1;
}

window.Ananke.HistoryController.prototype.update = function() {
	this.options.table.find("tbody").children().remove();
	
	var selectedDate = this.getSelectedDate();
	if(selectedDate == undefined) {
		this.options.heading.text("No History");
		return;
	}
	this.options.heading.text(selectedDate.toDateString());

	var archivedItems = this.options.historyRepo.getFrom(selectedDate);
	archivedItems.sort(function(a,b) { return a.startTime.getTime() - b.startTime.getTime() });

	for(var i = 0; i < archivedItems.length; i++) {
		this.options.template.tmpl(archivedItems[i], this.constructor.templateHelpers).appendTo(this.options.table);
	}
}

window.Ananke.HistoryController.templateHelpers = {}

window.Ananke.HistoryController.templateHelpers.startTime = function() {
	return this.data.startTime.getHumanTime();
}

window.Ananke.HistoryController.templateHelpers.endTime = function() {
	if(!this.data.isStopped) return "&mdash;"
	return this.data.isStopped.getHumanTime();
}

window.Ananke.HistoryController.templateHelpers.breakTime = function() {
	return this.data.getBreakTime();
}

window.Ananke.HistoryController.templateHelpers.totalDuration = function() {
	return this.data.getHumanElapsed();
}
		

$(document).ready(function() {
	var options = {
		historyRepo: new window.Ananke.HistoryRespository(localStorage, "Ananke.history"),
		template: $("#historyTemplate"),
		table: $("#taskHistory"),
		heading: $("#currentDay"),
		nextButton: $("#history header button.next"),
		previousButton: $("#history header button.prev")
	}

	new Ananke.HistoryController(options);
})
</script>
<link href="style.css" rel="stylesheet" type="text/css">
<style>
section.history header {
	height: 28px; 
	text-align: center;
	position: relative; 
}

section.history header .prev,
section.history header .next {
	position: absolute;
	top: 6px;
}

section.history header div.prev { left: 1em; }
section.history header div.next { right: 1em; }
section.history header span { line-height: 28px; }

#taskHistory { width: 100%; }
#taskHistory td.time { text-align: center; }

#taskHistory col.time { width: 7em; }
body { min-width: 800px; width: 80%; margin-left: auto; margin-right: auto;}
</style>
<script id="historyTemplate" type="text/x-jquery-tmpl">
<tr>
	<td>${name}</td>
	<td><a href="${url}">${url}</a></td>
	<td class="time">${$item.startTime()}</td>
	<td class="time">${$item.breakTime()}</td>
	<td class="time">${$item.endTime()}</td>
	<td class="time">${$item.totalDuration()}</td>
</tr>
</script>
</head>
<body>
	<section class="history">
		<header>
			<div class="prev"><button>&laquo;</button></div>
			<span id="currentDay"></span>
			<div class="next"><button>&raquo;</button></div>
		</header>
		<details>
			<table id="taskHistory">
				<col class="name" /><col class="link" />
				<col class="time" /><col class="time" />
				<col class="time" /><col class="time" />
				<thead>
					<th>Name</th>
					<th>Link</th>
					<th>Start</th>
					<th>Break</th>
					<th>End</th>
					<th>Total</th>
				</thead>
				<tbody></tbody>
				<tfoot>
				<tr>
				<td>Total</td>
				</tr>
				</tfoot>
			</table>
		</details>
	</section>
</body>
</html>